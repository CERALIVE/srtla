name: Build Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build srtla for ${{ matrix.arch }}
        run: |
          PLATFORM="linux/${{ matrix.arch }}"

          docker buildx build \
            --platform "$PLATFORM" \
            --load \
            -t srtla-builder:${{ matrix.arch }} \
            -f - . <<'DOCKERFILE'
          FROM debian:bookworm-slim
          RUN apt-get update && apt-get install -y \
              build-essential \
              cmake \
              git \
              libspdlog-dev \
              && rm -rf /var/lib/apt/lists/*
          WORKDIR /build
          COPY . .
          RUN cmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc)
          DOCKERFILE

      - name: Verify binaries were built
        run: |
          docker run --rm srtla-builder:${{ matrix.arch }} ls -la /build/build/srtla_send /build/build/srtla_rec

      - name: Build Summary
        run: |
          echo "## âœ… Build Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ${{ matrix.arch }}" >> $GITHUB_STEP_SUMMARY
